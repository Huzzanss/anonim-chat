<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Chat Anonim</title>

<style>

body{
    margin:0;
    font-family:system-ui;
    background:#0b141a;
    display:flex;
    flex-direction:column;
    height:100vh;
}

/* HEADER */
header{
    background:#202c33;
    color:white;
    padding:12px;
}

#online{
    font-size:12px;
    opacity:.7;
}

/* CHAT AREA */
#chat{
    flex:1;
    overflow-y:auto;
    padding:10px;
    background:#111b21;
}

/* MESSAGE */
.bubble{
    padding:10px;
    border-radius:12px;
    margin:8px 0;
    max-width:75%;
    color:white;
    word-wrap:break-word;
}

.me{
    background:#005c4b;
    margin-left:auto;
}

.other{
    background:#202c33;
}

img{
    max-width:100%;
    border-radius:10px;
    margin-top:5px;
}

/* TYPING */
#typing{
    font-size:12px;
    padding-left:10px;
    color:gray;
    height:18px;
}

/* INPUT */
form{
    display:flex;
    gap:5px;
    padding:8px;
    background:#202c33;
}

input[type="text"]{
    flex:1;
    padding:10px;
    border-radius:20px;
    border:none;
}

button{
    border:none;
    padding:10px 15px;
    border-radius:20px;
    background:#00a884;
    color:white;
    font-weight:bold;
}

.file{
    background:#00a884;
    padding:10px;
    border-radius:50%;
    cursor:pointer;
}

</style>
</head>
<body>

<header>
ðŸ’¬ Chat Anonim
<div id="online">Menghubungkan...</div>
</header>

<div id="chat"></div>

<div id="typing"></div>

<form onsubmit="sendText(event)">
    <label class="file">
        ðŸ“·
        <input type="file" id="imageInput" hidden accept="image/*">
    </label>

    <input id="msg" placeholder="Tulis pesan..." autocomplete="off">
    <button>Kirim</button>
</form>



<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>

<script>

// INIT
firebase.initializeApp({
    apiKey: "AIzaSyDIRVKsEXcaxxsrYr-6z7-AAakvgsfkFLo",
    authDomain: "anonim-chat-web.firebaseapp.com",
    databaseURL: "https://anonim-chat-web-default-rtdb.asia-southeast1.firebasedatabase.app/",
    projectId: "anonim-chat-web",
    storageBucket: "anonim-chat-web.firebasestorage.app",
    messagingSenderId: "888574930133",
    appId: "1:888574930133:web:c1cb6e0bc4e8ffcd64c65c",
    measurementId: "G-1NGL48QTY5"
});

const db = firebase.database();
const storage = firebase.storage();

const chat = document.getElementById("chat");
const input = document.getElementById("msg");

// user
const userId = Date.now() + Math.random().toString(36).substr(2);
const username = "User" + Math.floor(Math.random()*9999);



/* =========================
   ONLINE COUNTER
========================= */

const onlineRef = db.ref("online-users/" + userId);
const connectedRef = db.ref(".info/connected");

connectedRef.on("value", snap=>{

    if(snap.val()){
        onlineRef.set(true);
        onlineRef.onDisconnect().remove();
    }
});

db.ref("online-users").on("value", snap=>{
    document.getElementById("online").innerText =
        snap.numChildren() + " online";
});



/* =========================
   TYPING INDICATOR
========================= */

const typingRef = db.ref("typing/" + userId);

let timeout;

input.addEventListener("input", ()=>{

    typingRef.set(true);

    clearTimeout(timeout);

    timeout = setTimeout(()=>{
        typingRef.remove();
    },1500);
});

db.ref("typing").on("value", snap=>{

    let typingText = "";

    snap.forEach(child=>{
        if(child.key !== userId){
            typingText = "Seseorang sedang mengetik...";
        }
    });

    document.getElementById("typing").innerText = typingText;
});



/* =========================
   SEND TEXT
========================= */

function sendText(e){
    e.preventDefault();

    const text = input.value.trim();

    if(text === "") return;

    if(text.length > 200){
        alert("Maksimal 200 karakter!");
        return;
    }

    db.ref("messages").push({
        user:username,
        text:text,
        time:Date.now()
    });

    input.value="";
    typingRef.remove();
}



/* =========================
   SEND IMAGE
========================= */

document.getElementById("imageInput")
.addEventListener("change", async function(){

    const file = this.files[0];
    if(!file) return;

    if(file.size > 2 * 1024 * 1024){
        alert("Gambar maksimal 2MB!");
        return;
    }

    const ref = storage.ref("chat-images/" + Date.now());

    await ref.put(file);

    const url = await ref.getDownloadURL();

    db.ref("messages").push({
        user:username,
        image:url,
        time:Date.now()
    });
});



/* =========================
   RECEIVE MESSAGE
========================= */

db.ref("messages")
.limitToLast(100)
.on("child_added", snap=>{

    const data = snap.val();

    const div = document.createElement("div");

    div.className =
        "bubble " +
        (data.user === username ? "me":"other");

    let content =
        `<b>${data.user === username ? "Kamu" : data.user}</b><br>`;

    if(data.text){
        content += data.text;
    }

    if(data.image){
        content += `<img src="${data.image}">`;
    }

    div.innerHTML = content;

    chat.appendChild(div);

    chat.scrollTop = chat.scrollHeight;
});

</script>

</body>
</html>
