<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Chat Global</title>

<style>

body{
    margin:0;
    font-family:system-ui;
    height:100vh;
    background:linear-gradient(135deg,#0f2027,#203a43,#2c5364);
    display:flex;
}

/* JOIN */
#join{
    margin:auto;
    backdrop-filter:blur(20px);
    background:rgba(255,255,255,.08);
    padding:30px;
    border-radius:20px;
    color:white;
    width:280px;
}

input{
    width:100%;
    padding:12px;
    border-radius:10px;
    border:none;
    margin-top:10px;
}

button{
    width:100%;
    padding:12px;
    margin-top:10px;
    border:none;
    border-radius:10px;
    background:#00c896;
    color:white;
    font-weight:bold;
}

/* APP */

#app{
    display:none;
    flex-direction:column;
    width:100%;
}

header{
    background:rgba(0,0,0,.3);
    color:white;
    padding:12px;
}

#chat{
    flex:1;
    overflow:auto;
    padding:15px;
}

.bubble{
    max-width:70%;
    padding:10px;
    border-radius:12px;
    margin:8px 0;
    color:white;
}

.me{
    background:#00c896;
    margin-left:auto;
}

.other{
    background:rgba(255,255,255,.15);
}

img{
    max-width:100%;
    border-radius:10px;
    margin-top:5px;
}

form{
    display:flex;
    padding:10px;
    gap:5px;
    background:rgba(0,0,0,.3);
}

#typing{
    color:white;
    font-size:12px;
    padding-left:10px;
}

</style>
</head>
<body>

<!-- JOIN -->
<div id="join">
<h2>Masuk Chat</h2>
<input id="name" placeholder="Nama kamu">
<button onclick="join()">Masuk</button>
</div>


<!-- APP -->
<div id="app">

<header>
ðŸ’¬ Global Chat
<div id="online" style="font-size:12px;opacity:.8"></div>
</header>

<div id="chat"></div>
<div id="typing"></div>

<form onsubmit="sendText(event)">
    <input id="msg" placeholder="Tulis pesan...">
    <input type="file" id="imageInput" hidden accept="image/*">
    <button type="button" onclick="imageInput.click()">ðŸ“·</button>
    <button>Kirim</button>
</form>

</div>


<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>

<script>

firebase.initializeApp({
    apiKey: "AIzaSyDIRVKsEXcaxxsrYr-6z7-AAakvgsfkFLo",
    authDomain: "anonim-chat-web.firebaseapp.com",
    databaseURL: "https://anonim-chat-web-default-rtdb.asia-southeast1.firebasedatabase.app/",
    projectId: "anonim-chat-web",
    storageBucket: "anonim-chat-web.firebasestorage.app",
    messagingSenderId: "888574930133",
    appId: "1:888574930133:web:c1cb6e0bc4e8ffcd64c65c"
});

const db = firebase.database();
const storage = firebase.storage();

let username;
const userId = Date.now()+Math.random();

const chatRef = db.ref("global/messages");
const onlineRef = db.ref("global/online/"+userId);
const typingRef = db.ref("global/typing/"+userId);

function join(){

    username =
        document.getElementById("name").value ||
        "User"+Math.floor(Math.random()*9999);

    document.getElementById("join").style.display="none";
    document.getElementById("app").style.display="flex";
}


/* ONLINE */

db.ref(".info/connected").on("value", snap=>{
    if(snap.val()){
        onlineRef.set(true);
        onlineRef.onDisconnect().remove();
    }
});

db.ref("global/online")
.on("value", snap=>{
    document.getElementById("online").innerText =
        snap.numChildren()+" online";
});


/* RECEIVE */

chatRef.limitToLast(100)
.on("child_added", snap=>{

    const data = snap.val();

    const div = document.createElement("div");

    div.className =
        "bubble "+(data.user===username?"me":"other");

    let status="";

    if(data.user===username){
        status = data.read ? "âœ”âœ”":"âœ”";
    }

    div.innerHTML=
        `<b>${data.user}</b><br>
        ${data.text||""}
        ${data.image?`<img src="${data.image}">`:""}
        <div style="font-size:10px;opacity:.7">${status}</div>`;

    chat.appendChild(div);
    chat.scrollTop=chat.scrollHeight;

    if(data.user!==username){
        chatRef.child(snap.key).update({read:true});
    }
});


/* SEND */

function sendText(e){

    e.preventDefault();

    const input=document.getElementById("msg");
    const text=input.value.trim();

    if(!text) return;

    chatRef.push({
        user:username,
        text,
        read:false,
        time:Date.now()
    });

    input.value="";
    typingRef.remove();
}


/* IMAGE */

imageInput.onchange = async function(){

    const file=this.files[0];
    if(!file) return;

    const ref=storage.ref("global/"+Date.now());

    await ref.put(file);

    const url=await ref.getDownloadURL();

    chatRef.push({
        user:username,
        image:url,
        read:false,
        time:Date.now()
    });
}


/* TYPING */

const input=document.getElementById("msg");

let timeout;

input.addEventListener("input",()=>{

    typingRef.set(true);

    clearTimeout(timeout);

    timeout=setTimeout(()=>{
        typingRef.remove();
    },1500);
});

db.ref("global/typing")
.on("value",snap=>{

    let text="";

    snap.forEach(child=>{
        if(child.key!=userId){
            text="Seseorang sedang mengetik...";
        }
    });

    document.getElementById("typing").innerText=text;
});

</script>

</body>
</html>
